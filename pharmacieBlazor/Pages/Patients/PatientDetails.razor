@page "/patients/details/{Id:int}"
@using pharmacieBlazor.Models
@using pharmacieBlazor.Services.Interfaces
@inject IPatientService PatientService
@inject NavigationManager Navigation

<h3>
    <i class="bi bi-people-fill"></i> Détails du Patient
</h3>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
    </div>
}
else if (patient == null)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> Patient non trouvé.
    </div>
}
else
{
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">@patient.Nom</h5>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">ID:</dt>
                <dd class="col-sm-9">@patient.Id</dd>

                <dt class="col-sm-3">Nom:</dt>
                <dd class="col-sm-9">@patient.Nom</dd>

                <dt class="col-sm-3">Date de naissance:</dt>
                <dd class="col-sm-9">@patient.DateNaissance.ToString("dd/MM/yyyy")</dd>

                <dt class="col-sm-3">Âge:</dt>
                <dd class="col-sm-9">@CalculateAge(patient.DateNaissance) ans</dd>

                <dt class="col-sm-3">Nombre d'ordonnances:</dt>
                <dd class="col-sm-9">
                    <span class="badge bg-info">@patient.OrdonnanceIds.Count</span>
                </dd>

                @if (patient.OrdonnanceIds.Any())
                {
                    <dt class="col-sm-3">IDs des ordonnances:</dt>
                    <dd class="col-sm-9">
                        @foreach (var ordId in patient.OrdonnanceIds)
                        {
                            <span class="badge bg-secondary me-1">@ordId</span>
                        }
                    </dd>
                }
            </dl>
        </div>
        <div class="card-footer">
            <button class="btn btn-warning" @onclick="NavigateToEdit">
                <i class="bi bi-pencil"></i> Modifier
            </button>
            <button class="btn btn-secondary" @onclick="NavigateToList">
                <i class="bi bi-arrow-left"></i> Retour à la liste
            </button>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private PatientDto? patient;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        patient = await PatientService.GetByIdAsync(Id);
        isLoading = false;
    }

    private int CalculateAge(DateTime birthDate)
    {
        var today = DateTime.Today;
        var age = today.Year - birthDate.Year;
        if (birthDate.Date > today.AddYears(-age)) age--;
        return age;
    }

    private void NavigateToEdit()
    {
        Navigation.NavigateTo($"/patients/edit/{Id}");
    }

    private void NavigateToList()
    {
        Navigation.NavigateTo("/patients");
    }
}